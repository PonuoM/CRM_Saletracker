# ЁЯФз р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓ 500 Error р╣Гр╕Щр╕гр╕░р╕Ър╕Ъ Import/Export

## ЁЯУК р╕кр╕гр╕╕р╕Ыр╕Ыр╕▒р╕Нр╕лр╕▓ (Issue Summary)

**р╕Ыр╕▒р╕Нр╕лр╕▓:** р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф 500 Internal Server Error р╣Ар╕бр╕╖р╣Ир╕нр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕гр╕░р╕Ър╕Ъ Import/Export
```
import-export.php?action=importSales:1 Failed to load resource: the server responded with a status of 500 ()
import-export.js:101 Error: Error: Network response was not ok
```

---

## ЁЯФН р╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Ыр╕▒р╕Нр╕лр╕▓ (Problem Analysis)

### 1. **р╕Ыр╕▒р╕Нр╕лр╕▓ PDOStatement Object**
- р╣Ар╕бр╕Шр╕нр╕Ф `tableExists()` р╣Гр╕Щ `ImportExportService.php` р╣Гр╕Кр╣Й `$this->db->query()` р╣Бр╕ер╕░ `fetchAll()` р╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
- р╕Бр╕▓р╕гр╣Гр╕Кр╣Й `$this->db->query()` р╕кр╣Ир╕Зр╕Др╕╖р╕Щ PDOStatement Object р╣Бр╕Чр╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е

### 2. **р╕Ыр╕▒р╕Нр╕лр╕▓ Database Query**
- р╕Бр╕▓р╕гр╣Гр╕Кр╣Й `$stmt = $this->db->query()` р╣Бр╕ер╕░р╣Др╕бр╣Ир╣Др╕Фр╣Йр╣Гр╕Кр╣Йр╕Хр╕▒р╕зр╣Бр╕Ыр╕г `$stmt`
- р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕г error р╣Др╕бр╣Ир╕Др╕гр╕нр╕Ър╕Др╕ер╕╕р╕б

### 3. **р╕Ыр╕▒р╕Нр╕лр╕▓ Error Handling**
- р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕г error р╣Гр╕Щ controller р╣Др╕бр╣Ир╕бр╕╡р╕Бр╕▓р╕г log р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф
- р╕Бр╕▓р╕гр╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╣Др╕Яр╕ер╣Мр╕Кр╕▒р╣Ир╕зр╕Др╕гр╕▓р╕зр╣Др╕бр╣Ир╕Др╕гр╕нр╕Ър╕Др╕ер╕╕р╕б

---

## ЁЯЫая╕П р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕Чр╕╡р╣Ир╕Чр╕│ (Solutions Applied)

### 1. **р╣Бр╕Бр╣Йр╣Др╕В tableExists() Method**
```php
// р╕Бр╣Ир╕нр╕Щ (р╕Ьр╕┤р╕Ф)
private function tableExists($tableName) {
    try {
        $sql = "SHOW TABLES LIKE '{$tableName}'";
        $result = $this->db->query($sql);
        return count($result->fetchAll()) > 0;
    } catch (Exception $e) {
        return false;
    }
}

// р╕лр╕ер╕▒р╕З (р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З)
private function tableExists($tableName) {
    try {
        $sql = "SHOW TABLES LIKE '{$tableName}'";
        $result = $this->db->fetchAll($sql);
        return count($result) > 0;
    } catch (Exception $e) {
        error_log("Error checking table existence: " . $e->getMessage());
        return false;
    }
}
```

### 2. **р╣Бр╕Бр╣Йр╣Др╕В Database Query**
```php
// р╕Бр╣Ир╕нр╕Щ (р╕Ьр╕┤р╕Ф)
$stmt = $this->db->query($sql, [$customerId, $customerId]);

// р╕лр╕ер╕▒р╕З (р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З)
$this->db->query($sql, [$customerId, $customerId]);
```

### 3. **р╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕З Error Handling**
```php
// р╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕▓р╕г log error
error_log("Import Sales Error: " . $e->getMessage());
error_log("Stack trace: " . $e->getTraceAsString());

// р╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╕Бр╕▓р╕гр╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╣Др╕Яр╕ер╣М
if (file_exists($uploadedFile)) {
    unlink($uploadedFile);
}
```

---

## ЁЯУБ р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╣Бр╕Бр╣Йр╣Др╕В

### 1. `app/services/ImportExportService.php`
- тЬЕ р╣Бр╕Бр╣Йр╣Др╕В `tableExists()` method
- тЬЕ р╣Бр╕Бр╣Йр╣Др╕Вр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ `$this->db->query()`
- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б error logging

### 2. `app/controllers/ImportExportController.php`
- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б try-catch р╣Гр╕Щ `importSales()` р╣Бр╕ер╕░ `importCustomersOnly()`
- тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б error logging
- тЬЕ р╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╕Бр╕▓р╕гр╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╣Др╕Яр╕ер╣Мр╕Кр╕▒р╣Ир╕зр╕Др╕гр╕▓р╕з

### 3. `test_import_export_fix.php` (р╣Др╕Яр╕ер╣Мр╣Гр╕лр╕бр╣И)
- тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕В
- тЬЕ р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╕гр╣Йр╕▓р╕З service р╣Бр╕ер╕░ controller
- тЬЕ р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е
- тЬЕ р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Хр╕▓р╕гр╕▓р╕З
- тЬЕ р╕Чр╕Фр╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╕Бр╕▓р╕гр╣Ар╕Вр╕╡р╕вр╕Щр╣Др╕Яр╕ер╣М

---

## ЁЯзк р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ

### р╣Др╕Яр╕ер╣Мр╕Чр╕Фр╕кр╕нр╕Ър╕Чр╕╡р╣Ир╕кр╕гр╣Йр╕▓р╕З:
- `test_import_export_fix.php` - р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓

### р╕зр╕┤р╕Шр╕╡р╕Чр╕Фр╕кр╕нр╕Ъ:
1. р╣Ар╕Вр╣Йр╕▓р╣Др╕Ыр╕Чр╕╡р╣И `http://localhost/CRM-CURSOR/test_import_export_fix.php`
2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╣Бр╕кр╕Фр╕З "тЬЕ" р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
3. р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕г import р╣Др╕Яр╕ер╣М CSV р╣Гр╕Щр╕лр╕Щр╣Йр╕▓ Import/Export

### р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕╡р╣Ир╕Др╕▓р╕Фр╕лр╕зр╕▒р╕З:
```
тЬЕ ImportExportService р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕│р╣Ар╕гр╣Зр╕И
тЬЕ р╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╣Ар╕гр╣Зр╕И
тЬЕ р╕Хр╕▓р╕гр╕▓р╕З customers: р╕бр╕╡р╕нр╕вр╕╣р╣И
тЬЕ р╕Хр╕▓р╕гр╕▓р╕З orders: р╕бр╕╡р╕нр╕вр╕╣р╣И
тЬЕ ImportExportController р╕кр╕гр╣Йр╕▓р╕Зр╕кр╕│р╣Ар╕гр╣Зр╕И
тЬЕ р╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣М uploads р╕бр╕╡р╕нр╕вр╕╣р╣Ир╣Бр╕ер╣Йр╕з
тЬЕ р╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Вр╕╡р╕вр╕Щр╣Др╕Яр╕ер╣Мр╣Др╕Фр╣Й
тЬЕ р╣Др╕Яр╕ер╣М Template р╕бр╕╡р╕нр╕вр╕╣р╣И
```

---

## ЁЯУЛ Checklist р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕В

- [x] р╣Бр╕Бр╣Йр╣Др╕В PDOStatement Object issue
- [x] р╣Бр╕Бр╣Йр╣Др╕В Database Query methods
- [x] р╣Ар╕Юр╕┤р╣Ир╕б Error Handling
- [x] р╣Ар╕Юр╕┤р╣Ир╕б Error Logging
- [x] р╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╕Бр╕▓р╕гр╕Чр╕│р╕Др╕зр╕▓р╕бр╕кр╕░р╕нр╕▓р╕Фр╣Др╕Яр╕ер╣М
- [x] р╕кр╕гр╣Йр╕▓р╕Зр╣Др╕Яр╕ер╣Мр╕Чр╕Фр╕кр╕нр╕Ъ
- [x] р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ

---

## ЁЯОп р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М

### **р╕Бр╣Ир╕нр╕Щр╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕В:**
- тЭМ р╣Ар╕Бр╕┤р╕Ф 500 Internal Server Error
- тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Ц import р╣Др╕Яр╕ер╣М CSV р╣Др╕Фр╣Й
- тЭМ р╣Др╕бр╣Ир╕бр╕╡ error logging

### **р╕лр╕ер╕▒р╕Зр╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕В:**
- тЬЕ р╕гр╕░р╕Ър╕Ъ Import/Export р╕Чр╕│р╕Зр╕▓р╕Щр╣Др╕Фр╣Йр╕Ыр╕Бр╕Хр╕┤
- тЬЕ р╕кр╕▓р╕бр╕▓р╕гр╕Ц import р╣Др╕Яр╕ер╣М CSV р╣Др╕Фр╣Й
- тЬЕ р╕бр╕╡ error logging р╕кр╕│р╕лр╕гр╕▒р╕Ъ debugging
- тЬЕ р╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕Бр╕▓р╕г error р╕Др╕гр╕нр╕Ър╕Др╕ер╕╕р╕б

---

## ЁЯУЮ р╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б

р╕лр╕▓р╕Бр╕вр╕▒р╕Зр╕бр╕╡р╕Ыр╕▒р╕Нр╕лр╕▓ р╣Гр╕лр╣Йр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ:

1. **Error Logs**
   ```bash
   tail -f /var/log/apache2/error.log
   tail -f /var/log/php/error.log
   ```

2. **File Permissions**
   ```bash
   chmod -R 755 uploads/
   chown -R www-data:www-data uploads/
   ```

3. **Database Connection**
   - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Гр╕Щ `config/config.php`
   - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е

---

## тЬЕ р╕кр╕гр╕╕р╕Ы

**р╕Бр╕▓р╕гр╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╕▒р╕Нр╕лр╕▓ 500 Error р╣Гр╕Щр╕гр╕░р╕Ър╕Ъ Import/Export р╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щр╣Бр╕ер╣Йр╕з!**

р╕гр╕░р╕Ър╕Ър╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╣Бр╕ер╕░р╕Др╕зр╕гр╕Чр╕│р╕Зр╕▓р╕Щр╣Др╕Фр╣Йр╕Ыр╕Бр╕Хр╕┤р╣Вр╕Фр╕вр╣Др╕бр╣Ир╕бр╕╡ 500 error р╕нр╕╡р╕Бр╕Хр╣Ир╕нр╣Др╕Ы ЁЯЪА 