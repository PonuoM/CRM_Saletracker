  # Worklog — 2025-08-09

อ้างอิงหน้าเกี่ยวข้อง:
- Dashboard: [Customer/dashboard.php](https://www.prima49.com/Customer/dashboard.php)
- Orders: [Customer/orders.php](https://www.prima49.com/Customer/orders.php)
- Customer Detail (ตัวอย่าง): [customers.php?action=show&id=67](https://www.prima49.com/Customer/customers.php?action=show&id=67)

## สิ่งที่ปรับวันนี้
- Dashboard (telesales)
  - เพิ่มตัวเลือกเดือน (default เดือนปัจจุบัน) และสร้างกราฟรายวันแบบแท็บ:
    - แท็บ 1: กราฟแท่ง “ยอดขายต่อวัน (บาท)” แสดงวัน 1–สิ้นเดือน หากไม่มีข้อมูล = 0
    - แท็บ 2: กราฟผสม “คำสั่งซื้อ + รายชื่อติดต่อต่อวัน” (แท่ง = จำนวนออเดอร์, เส้น = จำนวนรายชื่อติดต่อ)
  - เพิ่ม KPI รวมทั้งหมด 8 การ์ด (รักษาการ์ดเดิม 4 ใบ และเพิ่มอีก 4 ใบ):
    - เดิม: ลูกค้าที่มอบหมาย, ลูกค้าต้องติดตาม, คำสั่งซื้อประจำเดือน (แทน “วันนี้”), ประสิทธิภาพ
    - เพิ่ม: ยอดขายประจำเดือน, ยอดขายปุ๋ยกระสอบใหญ่, ยอดขายปุ๋ยกระสอบเล็ก, ยอดขายชีวภัณฑ์ (แสดงยอดเงิน, จำนวน, หน่วย)
  - ลดพื้นที่แนวตั้ง: ย่อ padding/font size ของการ์ดและกราฟ + รวมกราฟไว้ในแท็บ
  - แก้ยอดขายให้นับเฉพาะคำสั่งซื้อที่ชำระเงินแล้ว (กรอง `payment_status = 'paid'`) ทั้งยอดรายวัน, KPI เดือน และรายหมวดสินค้า

- Orders
  - คอลัมน์ “การดำเนินการ”: เพิ่มสวิตช์ติ๊ก “ชำระแล้ว” (อัปเดต `payment_status` เป็น `paid`/`pending`)
  - ย้ายปุ่มลบไปไว้ในหน้าแก้ไข (คู่กับปุ่มอัปเดต)
  - ข้อความแจ้งเตือนย้ายขึ้นแสดงด้านบนสุดของหน้า orders (เลื่อนหน้าไปบนสุดอัตโนมัติ)
  - เปลี่ยนการแสดงรายการเป็น “โหลดเพิ่ม”: เริ่ม 10 แถว และปุ่ม “แสดงเพิ่มอีก 10” ต่อท้ายในตาราง (คงค่าตัวกรองเดิม)

## ไฟล์ที่แก้ไข
- `app/services/DashboardService.php` (เพิ่ม daily/monthly KPI และกรอง `paid`)
- `dashboard.php` (รับพารามิเตอร์เดือนและส่งข้อมูลให้ view)
- `app/views/dashboard/index.php` (แท็บกราฟ, 8 KPI, ลดพื้นที่)
- `assets/css/app.css` (ย่อ padding, ลดความสูงกราฟ)
- `app/views/orders/index.php` (สวิตช์ชำระแล้ว, ปุ่ม load more, คอนเทนเนอร์ alert ด้านบน)
- `assets/js/orders.js` (togglePaid, load more, renderRow, ปรับ showAlert ให้อยู่ด้านบน)
- `app/views/orders/edit.php` (ปุ่มลบในหน้าแก้ไข)
- `orders.php`, `app/controllers/OrderController.php` (เพิ่ม endpoint JSON `action=list` สำหรับโหลดเพิ่ม)

---

## สิ่งที่ต้องทำ (พรุ่งนี้)

### 1) ปรับ “กิจกรรมล่าสุด” ในหน้ารายละเอียดลูกค้าให้เข้าใจง่ายและครบถ้วน
- ปัญหาปัจจุบัน: แสดงเฉพาะ “บันทึกการโทร” และข้อความไม่เป็นมิตร เช่น “บันทึกการโทร: answered -” โดยข้อมูลนัดหมาย/คำสั่งซื้อไม่ปรากฏ
- แนวทางแก้:
  - รวมกิจกรรมจากหลายแหล่งของลูกค้าคนเดียวกัน (เรียงตามเวลา):
    - `call_logs` (การโทร), `appointments` (นัดหมาย), `orders` (คำสั่งซื้อ), และ `customer_activities` (กิจกรรมอื่นๆ)
  - ปรับข้อความให้อ่านง่าย (ไทย), ใส่ไอคอนตามประเภท และสรุป field สำคัญ
  - ตัวอย่างรูปแบบแสดงผล:
    - โทร: “โทรหาลูกค้า (รับสาย/ไม่รับ) 09/08/2025 22:50 โดย กิ๊ฟ Telesale” + หมายเหตุถ้ามี
    - นัดหมาย: “นัดหมาย (completed/confirmed/...) วันที่ … เวลา … โดย …”
    - คำสั่งซื้อ: “สร้างคำสั่งซื้อใหม่ หมายเลข XXX ยอดสุทธิ ฿xx.xx วันที่ … โดย …”
  - จำกัดแสดงล่าสุด 20 รายการ + ปุ่ม “ดูเพิ่ม”
- ไฟล์เป้าหมาย: `app/controllers/CustomerController.php`, `app/views/customers/show.php`

### 2) Sidebar แบบ Dynamic + ปุ่มปักหมุด (ทุกหน้า/ทุกบทบาท)
- โหมดหุบเหลือไอคอน (mini) และขยายอัตโนมัติเมื่อ hover (สมูท)
- ปุ่ม “ปักหมุด” เพื่อคงสถานะขยาย/หุบ (persist ด้วย `localStorage`)
- ส่วนเนื้อหา (content) ปรับความกว้างอัตโนมัติตาม sidebar (เต็มพื้นที่เมื่อหุบ)
- ไฟล์เป้าหมาย: `app/views/components/sidebar.php`, `assets/css/app.css`, `assets/js/sidebar.js`

### 3) Header Top + แก้ FOUT (Flash of Unstyled Text) ของฟอนต์ Sukhumvit
- เพิ่ม preload ฟอนต์ + ใช้ Font Loading API ลด FOUT
- จัดวาง header top ให้แสดงชื่อแอปและผู้ใช้ชัดเจน
- ไฟล์เป้าหมาย: `app/views/components/header.php`, `assets/css/app.css`, (อาจเพิ่ม) `assets/js/fonts.js`

---

## หมายเหตุ/ความเสี่ยง
- ปริมาณกิจกรรมอาจมาก: เพิ่มดัชนี/จำกัดจำนวน + lazy load
- Sidebar บนมือถือ: ใช้โหมดปักหมุดแทน hover
- ฟอนต์: preload เฉพาะไฟล์ที่ใช้งานจริง เพื่อลดผลกระทบ performance
