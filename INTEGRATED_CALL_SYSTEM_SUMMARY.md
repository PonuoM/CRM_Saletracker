# ระบบการโทรติดตามที่รวมเข้ากับหน้าจัดการลูกค้า

## สรุปการแก้ไขปัญหา

### ปัญหาที่เกิดขึ้น
1. **500 Internal Server Error** เมื่อเข้าถึง `calls.php` หน้าใหม่
2. ผู้ใช้ต้องการให้ระบบการโทรติดตามรวมเข้ากับหน้าจัดการลูกค้าแทนที่จะเป็นเมนูแยก เพื่อลดปัญหาที่อาจเกิดขึ้น

### วิธีแก้ไขที่เลือก
แทนที่จะสร้างหน้าแยกสำหรับการจัดการการโทร เราได้รวมฟังก์ชันการโทรติดตามเข้ากับหน้าจัดการลูกค้า (`customers.php`) โดยเพิ่ม Tab ใหม่ชื่อ "การโทรติดตาม"

## การเปลี่ยนแปลงที่ทำ

### 1. เพิ่ม Tab การโทรติดตามในหน้าจัดการลูกค้า
**ไฟล์:** `app/views/customers/index.php`

- เพิ่ม Tab "การโทรติดตาม" ในส่วน navigation
- เพิ่มเนื้อหา Tab ที่แสดง:
  - สถิติการโทร (การโทรทั้งหมด, ติดต่อได้, ต้องติดตาม, เกินกำหนด)
  - ตารางลูกค้าที่ต้องติดตามการโทร
  - ปุ่มกรองตามความเร่งด่วน (ทั้งหมด, เกินกำหนด, เร่งด่วน, เร็วๆ นี้)

### 2. เพิ่มฟังก์ชัน JavaScript สำหรับการจัดการการโทร
**ไฟล์:** `assets/js/customers.js`

เพิ่มฟังก์ชันใหม่:
- `loadCallStats()` - โหลดสถิติการโทร
- `loadCallFollowups(filter)` - โหลดรายการลูกค้าที่ต้องติดตาม
- `renderCallFollowupTable(customers)` - แสดงตารางลูกค้าที่ต้องติดตาม
- `getUrgencyClass(urgencyStatus)` - กำหนดสีตามความเร่งด่วน
- `getPriorityClass(priority)` - กำหนดสีตามความสำคัญ
- `logCallForCustomer(customerId)` - ไปยังหน้าบันทึกการโทร

### 3. สร้าง API Endpoint สำหรับการจัดการการโทร
**ไฟล์:** `api/calls.php`

สร้าง API endpoints:
- `GET api/calls.php?action=get_stats` - ดึงสถิติการโทร
- `GET api/calls.php?action=get_followup_customers&filter=all` - ดึงรายการลูกค้าที่ต้องติดตาม
- `POST api/calls.php?action=log_call` - บันทึกการโทร

### 4. ลบไฟล์และเมนูที่ไม่จำเป็น
- ลบไฟล์ `calls.php` (หน้าแยก)
- ลบเมนู "จัดการการโทร" จาก sidebar
- ลบไฟล์ `app/controllers/CallController.php` (ไม่จำเป็น)
- ลบไฟล์ `app/services/CallService.php` (ไม่จำเป็น)

## ข้อดีของการรวมระบบ

### 1. ลดความซับซ้อน
- ไม่ต้องสร้างหน้าใหม่
- ไม่ต้องจัดการ routing เพิ่มเติม
- ใช้โครงสร้างที่มีอยู่แล้ว

### 2. ประสบการณ์ผู้ใช้ที่ดีขึ้น
- ทุกฟังก์ชันการจัดการลูกค้าอยู่ในที่เดียวกัน
- ไม่ต้องสลับไปมาระหว่างหน้า
- UI ที่สอดคล้องกัน

### 3. การบำรุงรักษาที่ง่ายขึ้น
- โค้ดน้อยลง
- ไฟล์น้อยลง
- การแก้ไขง่ายขึ้น

## วิธีการใช้งาน

### 1. เข้าถึงระบบการโทรติดตาม
1. ไปที่หน้า "จัดการลูกค้า" (`customers.php`)
2. คลิกที่ Tab "การโทรติดตาม"
3. ระบบจะแสดงสถิติและรายการลูกค้าที่ต้องติดตาม

### 2. กรองข้อมูล
- **ทั้งหมด** - แสดงลูกค้าทั้งหมดที่ต้องติดตาม
- **เกินกำหนด** - แสดงลูกค้าที่เกินกำหนดการติดตาม (7 วัน)
- **เร่งด่วน** - แสดงลูกค้าที่ต้องติดตามเร่งด่วน (3 วัน)
- **เร็วๆ นี้** - แสดงลูกค้าที่ต้องติดตามเร็วๆ นี้ (1 วัน)

### 3. บันทึกการโทร
1. คลิกปุ่ม "โทร" ในตาราง
2. ระบบจะนำไปยังหน้าลูกค้าและแสดงฟอร์มบันทึกการโทร
3. กรอกข้อมูลการโทรและบันทึก

## ข้อกำหนดระบบ

### ฐานข้อมูลที่จำเป็น
- ตาราง `call_logs` - บันทึกการโทร
- ตาราง `customers` - ข้อมูลลูกค้า (ต้องมีคอลัมน์ `last_contact_at`)

### ฟังก์ชันที่รองรับ
- บันทึกการโทร
- ดูประวัติการโทร
- ติดตามลูกค้าที่ต้องโทรกลับ
- สถิติการโทร

## การทดสอบ

รันไฟล์ `test_integrated_call_system.php` เพื่อตรวจสอบว่าระบบทำงานถูกต้อง:

```bash
php test_integrated_call_system.php
```

## สรุป

ระบบการโทรติดตามได้รวมเข้ากับหน้าจัดการลูกค้าเรียบร้อยแล้ว โดยไม่ต้องสร้างหน้าแยกหรือเมนูใหม่ ทำให้ระบบมีความซับซ้อนน้อยลงและง่ายต่อการบำรุงรักษา ผู้ใช้สามารถเข้าถึงฟังก์ชันการโทรติดตามได้ผ่าน Tab "การโทรติดตาม" ในหน้าจัดการลูกค้า
