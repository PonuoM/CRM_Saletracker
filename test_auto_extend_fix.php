<?php
/**
 * ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ autoExtendTimeOnActivity ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó basket_type ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
 */

require_once __DIR__ . '/config/config.php';
require_once __DIR__ . '/app/core/Database.php';
require_once __DIR__ . '/app/services/WorkflowService.php';
require_once __DIR__ . '/app/services/OrderService.php';

echo "üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥\n";

try {
    $db = new Database();
    echo "‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n\n";
    
    $workflowService = new WorkflowService();
    $orderService = new OrderService();
    
    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ basket_type ‡∏ï‡πà‡∏≤‡∏á‡πÜ
    echo "1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ basket_type ‡∏ï‡πà‡∏≤‡∏á‡πÜ\n";
    $customers = $db->fetchAll("
        SELECT customer_id, CONCAT(first_name, ' ', last_name) as customer_name, 
               basket_type, assigned_at, customer_time_expiry, customer_time_extension
        FROM customers 
        WHERE assigned_at IS NOT NULL 
        ORDER BY customer_id
    ");
    
    foreach ($customers as $customer) {
        echo "- {$customer['customer_name']} (ID: {$customer['customer_id']}) basket_type: {$customer['basket_type']}\n";
    }
    echo "\n";
    
    // 2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö autoExtendTimeOnActivity ‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    echo "2. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö autoExtendTimeOnActivity ‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó\n";
    
    foreach ($customers as $customer) {
        echo "üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: {$customer['customer_name']} (ID: {$customer['customer_id']}) basket_type: {$customer['basket_type']}\n";
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        echo "üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:\n";
        echo "- assigned_at: {$customer['assigned_at']}\n";
        echo "- customer_time_expiry: {$customer['customer_time_expiry']}\n";
        echo "- customer_time_extension: {$customer['customer_time_extension']}\n";
        
        // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö autoExtendTimeOnActivity
        $result = $workflowService->autoExtendTimeOnActivity($customer['customer_id'], 'order', 1);
        
        echo "üîÑ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö autoExtendTimeOnActivity:\n";
        echo "- success: " . ($result['success'] ? 'true' : 'false') . "\n";
        echo "- message: {$result['message']}\n";
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö
        $updatedCustomer = $db->fetchOne("
            SELECT assigned_at, customer_time_expiry, customer_time_extension
            FROM customers WHERE customer_id = ?
        ", [$customer['customer_id']]);
        
        echo "üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö:\n";
        echo "- assigned_at: {$updatedCustomer['assigned_at']}\n";
        echo "- customer_time_expiry: {$updatedCustomer['customer_time_expiry']}\n";
        echo "- customer_time_extension: {$updatedCustomer['customer_time_extension']}\n";
        
        if ($result['success']) {
            echo "‚úÖ ‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n";
        } else {
            echo "‚ùå ‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\n";
        }
        echo "\n";
    }
    
    // 3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á
    echo "3. ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á\n";
    
    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ basket_type = 'waiting' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏î‡∏™‡∏≠‡∏ö
    $testCustomer = $db->fetchOne("
        SELECT customer_id, CONCAT(first_name, ' ', last_name) as customer_name, basket_type
        FROM customers 
        WHERE basket_type = 'waiting' AND assigned_at IS NOT NULL
        LIMIT 1
    ");
    
    if ($testCustomer) {
        echo "üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: {$testCustomer['customer_name']} (ID: {$testCustomer['customer_id']}) basket_type: {$testCustomer['basket_type']}\n";
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        $beforeOrder = $db->fetchOne("
            SELECT assigned_at, customer_time_expiry, customer_time_extension
            FROM customers WHERE customer_id = ?
        ", [$testCustomer['customer_id']]);
        
        echo "üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:\n";
        echo "- assigned_at: {$beforeOrder['assigned_at']}\n";
        echo "- customer_time_expiry: {$beforeOrder['customer_time_expiry']}\n";
        echo "- customer_time_extension: {$beforeOrder['customer_time_extension']}\n";
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á
        $orderData = [
            'customer_id' => $testCustomer['customer_id'],
            'order_date' => date('Y-m-d H:i:s'),
            'total_amount' => 1000,
            'discount_amount' => 0,
            'net_amount' => 1000,
            'payment_method' => 'cash',
            'payment_status' => 'pending',
            'delivery_status' => 'pending',
            'notes' => '‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥'
        ];
        
        $orderItems = [
            [
                'product_id' => 1,
                'quantity' => 1,
                'unit_price' => 1000
            ]
        ];
        
        $orderResult = $orderService->createOrder($orderData, $orderItems, 1);
        
        echo "üîÑ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:\n";
        echo "- success: " . ($orderResult['success'] ? 'true' : 'false') . "\n";
        echo "- message: {$orderResult['message']}\n";
        if (isset($orderResult['order_id'])) {
            echo "- order_id: {$orderResult['order_id']}\n";
        }
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
        $afterOrder = $db->fetchOne("
            SELECT assigned_at, customer_time_expiry, customer_time_extension
            FROM customers WHERE customer_id = ?
        ", [$testCustomer['customer_id']]);
        
        echo "üìÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠:\n";
        echo "- assigned_at: {$afterOrder['assigned_at']}\n";
        echo "- customer_time_expiry: {$afterOrder['customer_time_expiry']}\n";
        echo "- customer_time_extension: {$afterOrder['customer_time_extension']}\n";
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        if ($beforeOrder['assigned_at'] !== $afterOrder['assigned_at']) {
            echo "‚úÖ assigned_at ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß\n";
        } else {
            echo "‚ùå assigned_at ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô\n";
        }
        
        if ($beforeOrder['customer_time_expiry'] !== $afterOrder['customer_time_expiry']) {
            echo "‚úÖ customer_time_expiry ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß\n";
        } else {
            echo "‚ùå customer_time_expiry ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô\n";
        }
        
        if ($beforeOrder['customer_time_extension'] !== $afterOrder['customer_time_extension']) {
            echo "‚úÖ customer_time_extension ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß\n";
        } else {
            echo "‚ùå customer_time_extension ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô\n";
        }
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
        echo "\n4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°\n";
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö customer_activities (‡∏à‡∏≤‡∏Å WorkflowService)
        $customerActivities = $db->fetchAll("
            SELECT activity_type, description, created_at
            FROM customer_activities 
            WHERE customer_id = ? 
            ORDER BY created_at DESC 
            LIMIT 5
        ", [$testCustomer['customer_id']]);
        
        echo "üìã ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (customer_activities):\n";
        if (empty($customerActivities)) {
            echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°\n";
        } else {
            foreach ($customerActivities as $activity) {
                echo "- {$activity['activity_type']}: {$activity['description']} ({$activity['created_at']})\n";
            }
        }
        
                 // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö order_activities (‡∏à‡∏≤‡∏Å OrderService)
         if (isset($orderResult['order_id'])) {
             $orderActivities = $db->fetchAll("
                 SELECT activity_type, description, created_at
                 FROM order_activities 
                 WHERE order_id = ? 
                 ORDER BY created_at DESC 
                 LIMIT 5
             ", [$orderResult['order_id']]);
             
             echo "üìã ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (order_activities):\n";
             if (empty($orderActivities)) {
                 echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°\n";
             } else {
                 foreach ($orderActivities as $activity) {
                     echo "- {$activity['activity_type']}: {$activity['description']} ({$activity['created_at']})\n";
                 }
             }
         }
        
    } else {
        echo "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ basket_type = 'waiting' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö\n";
    }
    
    echo "\n‚úÖ ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô\n";
    
} catch (Exception $e) {
    echo "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " . $e->getMessage() . "\n";
    error_log("Test error: " . $e->getMessage());
}
?> 