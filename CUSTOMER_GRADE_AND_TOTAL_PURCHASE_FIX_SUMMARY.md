# การแก้ไขปัญหาการแสดงยอดซื้อรวมและเกรดลูกค้า

## ปัญหาที่พบ

### 1. การแสดงยอดซื้อรวมไม่ขึ้นในหน้าแสดงรายละเอียดลูกค้า
- **ปัญหา**: หน้า `app/views/customers/show.php` ใช้ `total_purchase` แทน `total_purchase_amount`
- **ผลกระทบ**: ยอดซื้อรวมแสดงเป็น 0 แม้ว่าในฐานข้อมูลจะมีข้อมูลแล้ว

### 2. เกรดลูกค้าไม่ถูกอัปเดตตามยอดซื้อรวม
- **ปัญหา**: เกรดลูกค้ายังคงเป็น D แม้ว่ายอดซื้อรวมจะเกินเกณฑ์ขั้นต่ำแล้ว
- **ผลกระทบ**: การจัดลำดับความสำคัญของลูกค้าไม่ถูกต้อง

## การแก้ไขที่ดำเนินการ

### 1. แก้ไขการแสดงยอดซื้อรวมในหน้า show.php

**ไฟล์ที่แก้ไข**: `app/views/customers/show.php`

**การเปลี่ยนแปลง**:
```php
// เปลี่ยนจาก
฿<?php echo number_format($customer['total_purchase'] ?? 0, 2); ?>

// เป็น
฿<?php echo number_format($customer['total_purchase_amount'] ?? 0, 2); ?>
```

**ตำแหน่งที่แก้ไข**:
- บรรทัด 107: การแสดงยอดซื้อรวมในส่วนข้อมูลลูกค้า
- บรรทัด 138: การแสดงยอดซื้อรวมในส่วนสถิติสรุป

### 2. สร้างสคริปต์แก้ไขเกรดลูกค้า

**ไฟล์ที่สร้าง**: `fix_customer_grade_and_total_purchase.php`

**ฟังก์ชันหลัก**:
1. **ตรวจสอบสถานะปัจจุบัน**: แสดงสถิติลูกค้าและเกรดปัจจุบัน
2. **ตรวจสอบการตั้งค่าเกรด**: ตรวจสอบและสร้างการตั้งค่าเริ่มต้น (ถ้าจำเป็น)
3. **อัปเดตเกรดลูกค้า**: อัปเดตเกรดลูกค้าทั้งหมดตามยอดซื้อรวม
4. **ตรวจสอบผลลัพธ์**: แสดงการเปลี่ยนแปลงของเกรดลูกค้า
5. **แสดงตัวอย่าง**: แสดงตัวอย่างลูกค้าที่เกรดเปลี่ยน

### 3. การตั้งค่าเกรดเริ่มต้น

**เกณฑ์เกรดที่ใช้**:
- **A+**: ≥ ฿100,000
- **A**: ≥ ฿50,000
- **B**: ≥ ฿20,000
- **C**: ≥ ฿5,000
- **D**: < ฿5,000

## วิธีการใช้งาน

### 1. รันสคริปต์แก้ไข
```bash
php fix_customer_grade_and_total_purchase.php
```

### 2. ตรวจสอบผลลัพธ์
- เปิดหน้าแสดงรายละเอียดลูกค้า: `customers.php?action=show&id=44`
- ตรวจสอบว่ายอดซื้อรวมแสดงถูกต้อง
- ตรวจสอบว่าเกรดลูกค้าถูกอัปเดตตามยอดซื้อรวม

## ผลลัพธ์ที่คาดหวัง

### 1. การแสดงยอดซื้อรวม
- ยอดซื้อรวมจะแสดงจำนวนเงินที่ถูกต้องจากคอลัมน์ `total_purchase_amount`
- ไม่แสดง 0 อีกต่อไป

### 2. การอัปเดตเกรดลูกค้า
- ลูกค้าที่มียอดซื้อรวม ≥ ฿100,000 จะได้เกรด A+
- ลูกค้าที่มียอดซื้อรวม ≥ ฿50,000 จะได้เกรด A
- ลูกค้าที่มียอดซื้อรวม ≥ ฿20,000 จะได้เกรด B
- ลูกค้าที่มียอดซื้อรวม ≥ ฿5,000 จะได้เกรด C
- ลูกค้าที่มียอดซื้อรวม < ฿5,000 จะได้เกรด D

## การตรวจสอบ

### 1. ตรวจสอบหน้าแสดงลูกค้า
- ไปที่: `customers.php?action=show&id=44`
- ตรวจสอบว่ายอดซื้อรวมแสดงถูกต้อง
- ตรวจสอบว่าเกรดลูกค้าถูกต้อง

### 2. ตรวจสอบการตั้งค่าเกรด
- ไปที่: `admin.php?action=settings`
- ตรวจสอบการตั้งค่าเกรดในส่วน "การตั้งค่าเกรดลูกค้า"

### 3. ตรวจสอบฐานข้อมูล
```sql
-- ตรวจสอบยอดซื้อรวม
SELECT customer_id, first_name, last_name, total_purchase_amount, customer_grade 
FROM customers 
WHERE total_purchase_amount > 0 
ORDER BY total_purchase_amount DESC 
LIMIT 10;

-- ตรวจสอบการกระจายเกรด
SELECT customer_grade, COUNT(*) as count 
FROM customers 
GROUP BY customer_grade 
ORDER BY customer_grade;
```

## หมายเหตุสำคัญ

1. **ความปลอดภัย**: การแก้ไขนี้ไม่กระทบกับข้อมูลอื่นในระบบ
2. **การสำรองข้อมูล**: ควรสำรองฐานข้อมูลก่อนรันสคริปต์
3. **การทดสอบ**: ทดสอบในระบบทดสอบก่อนใช้งานจริง
4. **การติดตาม**: ตรวจสอบผลลัพธ์หลังการแก้ไข

## ไฟล์ที่เกี่ยวข้อง

- `app/views/customers/show.php` - หน้าแสดงรายละเอียดลูกค้า
- `fix_customer_grade_and_total_purchase.php` - สคริปต์แก้ไขปัญหา
- `app/services/CustomerService.php` - บริการจัดการลูกค้า
- `app/services/CronJobService.php` - บริการงานอัตโนมัติ
- `app/controllers/CustomerController.php` - ตัวควบคุมลูกค้า
